name: Update VLCKit

on:
  schedule:
    - cron: '0 0 1 * *' # First day of every month at midnight UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Find latest VLCKit version
        id: find-latest
        run: |
          PAGE=$(curl -sfL https://download.videolan.org/pub/cocoapods/unstable/) || {
            echo "::error::Failed to fetch VideoLAN directory listing"
            exit 1
          }

          LATEST=$(echo "$PAGE" | grep -o 'href="VLCKit-[^"]*\.tar\.xz"' | sed 's/href="//;s/"//' | sort -V | tail -1 || true)

          if [ -z "$LATEST" ]; then
            echo "::error::Could not find any VLCKit tar.xz files"
            exit 1
          fi

          VERSION=$(echo "$LATEST" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+[a-z]+[0-9]+' || true)

          if [ -z "$VERSION" ]; then
            echo "::error::Could not extract version from $LATEST"
            exit 1
          fi

          DOWNLOAD_URL="https://download.videolan.org/pub/cocoapods/unstable/$LATEST"

          echo "latest_file=$LATEST" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "Found latest: $LATEST (version $VERSION)"

      - name: Check if update is needed
        id: check
        run: |
          CURRENT_VERSION=$(sed -n 's|.*/download/v\([^/]*\)/.*|\1|p' Package.swift)
          NEW_VERSION="${{ steps.find-latest.outputs.version }}"

          echo "Current: $CURRENT_VERSION"
          echo "Latest: $NEW_VERSION"

          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Already on latest version: $CURRENT_VERSION"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Updating from $CURRENT_VERSION to $NEW_VERSION"
          fi

      - name: Download and extract
        if: steps.check.outputs.skip != 'true'
        run: |
          mkdir -p .tmp/
          wget -q -O .tmp/VLCKit.tar.xz "${{ steps.find-latest.outputs.download_url }}"
          tar -xf .tmp/VLCKit.tar.xz -C .tmp/

      - name: Create xcframework zip
        if: steps.check.outputs.skip != 'true'
        run: |
          cd .tmp/VLCKit-binary
          zip -ry ../../VLCKit.xcframework.zip VLCKit.xcframework
          cd ../..

      - name: Compute checksum and update Package.swift
        if: steps.check.outputs.skip != 'true'
        id: checksum
        run: |
          CHECKSUM=$(sha256sum VLCKit.xcframework.zip | awk '{print $1}')
          VERSION="${{ steps.find-latest.outputs.version }}"

          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "Checksum: $CHECKSUM"

          sed -i \
            -e "s|/download/v[^/]*/|/download/v$VERSION/|" \
            -e "s|checksum: \"[a-f0-9]\{64\}\"|checksum: \"$CHECKSUM\"|" \
            Package.swift

          echo "Updated Package.swift:"
          grep -A1 'url:' Package.swift

      - name: Copy license
        if: steps.check.outputs.skip != 'true'
        run: cp -f .tmp/VLCKit-binary/COPYING.txt ./LICENSE

      - name: Cleanup
        if: steps.check.outputs.skip != 'true'
        run: rm -rf .tmp/

      - name: Commit and push
        if: steps.check.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.find-latest.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Package.swift LICENSE
          git commit -m "v$VERSION"
          git push

      - name: Create release and upload artifact
        if: steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.find-latest.outputs.version }}"
          gh release create "v$VERSION" \
            VLCKit.xcframework.zip \
            --title "v$VERSION" \
            --notes "Updated VLCKit to v$VERSION from VideoLAN unstable builds."

      - name: Summary
        if: steps.check.outputs.skip != 'true'
        run: |
          VERSION="${{ steps.find-latest.outputs.version }}"
          echo "### VLCKit Updated to v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Checksum:** ${{ steps.checksum.outputs.checksum }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** ${{ steps.find-latest.outputs.download_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release:** https://github.com/${{ github.repository }}/releases/tag/v$VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Summary (no update)
        if: steps.check.outputs.skip == 'true'
        run: |
          CURRENT_VERSION=$(sed -n 's|.*/download/v\([^/]*\)/.*|\1|p' Package.swift)
          echo "### No Update Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Already on latest version: **$CURRENT_VERSION**" >> $GITHUB_STEP_SUMMARY
